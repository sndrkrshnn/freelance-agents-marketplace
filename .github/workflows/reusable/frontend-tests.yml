name: Reusable Frontend Tests

on:
  workflow_call:
    inputs:
      working-directory:
        required: true
        type: string
      node-version:
        type: string
        default: '18'
      run-type-check:
        type: boolean
        default: true
      run-build:
        type: boolean
        default: true
      run-tests:
        type: boolean
        default: true
      upload-artifact:
        type: boolean
        default: true

    outputs:
      lint-result:
        value: ${{ jobs.frontend-lint.outputs.result }}
      type-check-result:
        value: ${{ jobs.frontend-test.outputs.type-check }}
      build-result:
        value: ${{ jobs.frontend-build.outputs.result }}
      
    secrets:
      VITE_API_URL:
        required: false
      VITE_STRIPE_PUBLIC_KEY:
        required: false

jobs:
  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      result: ${{ steps.lint.outcome }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json
      
      - name: Cache ESLint
        uses: actions/cache@v4
        with:
          path: |
            ${{ inputs.working-directory }}/.eslintcache
            ${{ inputs.working-directory }}/node_modules/.cache
          key: ${{ runner.os }}-eslint-frontend-${{ hashFiles(format('{0}/package-lock.json', inputs.working-directory)) }}
          restore-keys: |
            ${{ runner.os }}-eslint-frontend-
      
      - name: Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: |
          npm ci --prefer-offline --no-audit
      
      - name: Run ESLint
        id: lint
        working-directory: ${{ inputs.working-directory }}
        run: npm run lint
      
      - name: Run Prettier check
        working-directory: ${{ inputs.working-directory }}
        run: npm run format:check --if-present || npx prettier --check "**/*.{ts,tsx,json,css,md}"
        continue-on-error: true

  frontend-type-check:
    name: Frontend Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: inputs.run-type-check == true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json
      
      - name: Cache TypeScript
        uses: actions/cache@v4
        with:
          path: ${{ inputs.working-directory }}/node_modules/.cache
          key: ${{ runner.os }}-tsc-frontend-${{ hashFiles(format('{0}/tsconfig.json', inputs.working-directory)) }}
          restore-keys: |
            ${{ runner.os }}-tsc-frontend-
      
      - name: Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: |
          npm ci --prefer-offline --no-audit
      
      - name: Run TypeScript type check
        working-directory: ${{ inputs.working-directory }}
        run: npm run type-check
      
      - name: Check for TypeScript errors
        working-directory: ${{ inputs.working-directory }}
        run: |
          npx tsc --noEmit --pretty || {
            echo "TypeScript errors detected!"
            exit 1
          }

  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: frontend-lint
    if: inputs.run-build == true
    outputs:
      result: ${{ steps.build.outcome }}
    
    strategy:
      matrix:
        node-version: [18, 20]
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json
      
      - name: Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: |
          npm ci --prefer-offline --no-audit
      
      - name: Build frontend
        id: build
        working-directory: ${{ inputs.working-directory }}
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL || 'https://api.example.com' }}
          VITE_STRIPE_PUBLIC_KEY: ${{ secrets.VITE_STRIPE_PUBLIC_KEY || 'pk_test_dummy' }}
        run: npm run build
      
      - name: Check build output
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [ ! -d "dist" ]; then
            echo "Error: dist directory not found after build"
            exit 1
          fi
          
          # Check bundle size
          TOTAL_SIZE=$(du -sh dist | cut -f1)
          echo "ðŸ“¦ Build size: ${TOTAL_SIZE}"
          echo "## ðŸ“¦ Build Size (Node ${{ matrix.node-version }})" >> $GITHUB_STEP_SUMMARY
          echo "Total: ${TOTAL_SIZE}" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload build artifact
        if: inputs.upload-artifact == true
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist-node-${{ matrix.node-version }}
          path: ${{ inputs.working-directory }}/dist/
          retention-days: 7
      
      - name: Analyze bundle
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "## ðŸ“Š Bundle Analysis (Node ${{ matrix.node-version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          find dist -type f -name "*.js" -exec du -h {} \; | sort -hr | head -20 | \
            awk '{print "| " $2 " | " $1 " |"}' >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: frontend-lint
    if: inputs.run-tests == true
    outputs:
      type-check: ${{ steps.type-check.outcome }}
      test-result: ${{ steps.test.outcome }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json
      
      - name: Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: |
          npm ci --prefer-offline --no-audit
      
      - name: Type check
        id: type-check
        working-directory: ${{ inputs.working-directory }}
        run: npm run type-check --if-present
        continue-on-error: true
      
      - name: Run unit tests
        id: test
        working-directory: ${{ inputs.working-directory }}
        run: npm test --if-present -- --passWithNoTests --ci --coverage --maxWorkers=2
        continue-on-error: true
      
      - name: Upload test coverage
        if: steps.test.outcome == 'success'
        uses: codecov/codecov-action@v4
        with:
          files: ${{ inputs.working-directory }}/coverage/lcov.info
          flags: frontend
          name: frontend-tests
        continue-on-error: true

  bundle-size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: frontend-build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist-node-18
          path: ./dist
        continue-on-error: true
      
      - name: Check bundle size
        run: |
          if [ -d "./dist" ]; then
            echo "## ðŸ“Š Bundle Size Check" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Check total size
            TOTAL_SIZE=$(du -sh ./dist | cut -f1)
            echo "**Total size:** ${TOTAL_SIZE}" >> $GITHUB_STEP_SUMMARY
            
            # Check largest files
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Largest files:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            find dist -type f -exec du -h {} + | sort -rh | head -10 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # Warn if too large (e.g., > 5MB)
            SIZE_BYTES=$(du -sb ./dist | cut -f1)
            if [ "$SIZE_BYTES" -gt 5242880 ]; then
              echo "âš ï¸ Warning: Bundle exceeds 5MB" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No build artifact found" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [frontend-lint, frontend-type-check, frontend-build, frontend-tests]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ”Ž Frontend Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.frontend-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | ${{ needs.frontend-type-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.frontend-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.frontend-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.frontend-lint.result }}" == "success" ] && \
             [ "${{ needs.frontend-type-check.result }}" != "failure" ] && \
             [ "${{ needs.frontend-build.result }}" == "success" ]; then
            echo "âœ… All frontend checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some frontend checks failed!" >> $GITHUB_STEP_SUMMARY
          fi
