name: Snyk Security Scan

on:
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/package.json'
      - 'backend/package.json'
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/package.json'
      - 'backend/package.json'

permissions:
  contents: read

jobs:
  snyk:
    name: Snyk Vulnerability Scanner
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - name: frontend
            path: frontend
          - name: backend
            path: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --sarif-file-output=snyk-{{ matrix.name }}.sarif
          command: test
          working-directory: ${{ matrix.path }}

      - name: Upload Snyk results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: ${{ matrix.path }}/snyk-{{ matrix.name }}.sarif
          category: snyk-{{ matrix.name }}

  snyk-code:
    name: Snyk Code (SAST)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run Snyk Code to check for code issues
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --sarif-file-output=snyk-code.sarif
          command: code scan
          working-directory: .

      - name: Upload Snyk Code results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: snyk-code.sarif
          category: snyk-code

  snyk-container:
    name: Snyk Container Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker images
        run: |
          docker-compose -f docker-compose.yml build

      - name: Run Snyk to scan backend container
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: freelance-agents-marketplace-backend
          args: --severity-threshold=high --sarif-file-output=snyk-backend-container.sarif

      - name: Run Snyk to scan frontend container
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: freelance-agents-marketplace-frontend
          args: --severity-threshold=high --sarif-file-output=snyk-frontend-container.sarif

      - name: Upload Snyk Container results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: snyk-backend-container.sarif
          category: snyk-backend-container

      - name: Upload Snyk Container results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: snyk-frontend-container.sarif
          category: snyk-frontend-container
